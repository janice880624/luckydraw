<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æŠ½çç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©å‹•ç•«ï¼Œç”¨æ–¼æŠ½çæ™‚é–ƒçˆæ•ˆæœ */
        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .animate-pulse-fast {
            animation: pulse-fast 0.1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-8">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-900 flex items-center">
                ğŸ† å¹¸é‹æŠ½çç³»çµ± 
            </h1>
            <div id="statusMessage" class="mt-3 p-3 text-sm rounded-lg hidden"></div>
        </header>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6" id="tabNavigation">
            <button data-tab="draw" class="tab-button active-tab">æŠ½ç</button>
            <button data-tab="setup" class="tab-button">è¨­å®š</button>
            <button data-tab="results" class="tab-button">çµæœ</button>
        </div>

        <!-- Tab Content Containers -->
        <div id="draw-panel" class="tab-content"></div>
        <div id="setup-panel" class="tab-content hidden"></div>
        <div id="results-panel" class="tab-content hidden"></div>

        <!-- Footer -->
        <footer class="mt-8 pt-4 border-t text-xs text-gray-400 text-center">
            <p>Copyright Â© 2025 Janice. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // --- Global State & Constants ---
        const STORAGE_KEY = 'luckyDrawAppState';
        let appState = {
            participants: [],
            prizes: [],
            results: [],
            isDrawing: false,
            currentWinner: null,
            shufflingName: '',
            selectedPrizeId: null // æ–°å¢ï¼šç”¨æ–¼è¿½è¹¤ç•¶å‰é¸å–çš„çé … ID
        };
        let shuffleInterval;

        // --- Utility Functions ---

        /**
         * è¼‰å…¥ Local Storage æ•¸æ“š
         */
        const loadState = () => {
            try {
                const storedState = localStorage.getItem(STORAGE_KEY);
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    appState.participants = loadedState.participants || [];
                    appState.prizes = loadedState.prizes || [];
                    appState.results = loadedState.results || [];
                    // å˜—è©¦è¼‰å…¥é¸å–çš„çé …IDï¼Œå¦‚æœæ²’æœ‰å‰‡æœƒä¿æŒ null
                    appState.selectedPrizeId = loadedState.selectedPrizeId || null;
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                showStatusMessage("éŒ¯èª¤ï¼šç„¡æ³•å¾æœ¬åœ°å„²å­˜ç©ºé–“è¼‰å…¥è³‡æ–™ã€‚", 'error');
            }
        };

        const saveState = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    participants: appState.participants,
                    prizes: appState.prizes,
                    results: appState.results,
                    selectedPrizeId: appState.selectedPrizeId // å„²å­˜é¸å–çš„çé … ID
                }));
                showStatusMessage("è³‡æ–™å·²å„²å­˜æ–¼ Local Storageã€‚", 'success');
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
                showStatusMessage("éŒ¯èª¤ï¼šç„¡æ³•å°‡è³‡æ–™å„²å­˜åˆ°æœ¬åœ°å„²å­˜ç©ºé–“ã€‚", 'error');
            }
        };

        /**
         * é¡¯ç¤ºæ‡‰ç”¨ç¨‹å¼ç‹€æ…‹è¨Šæ¯
         * @param {string} message - é¡¯ç¤ºçš„è¨Šæ¯
         * @param {'success'|'error'|'info'} type - è¨Šæ¯é¡å‹
         */
        const showStatusMessage = (message, type = 'info') => {
            const el = document.getElementById('statusMessage');
            if (!el) return;

            el.textContent = message;
            el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');

            if (type === 'error') {
                el.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                el.classList.add('bg-green-100', 'text-green-700');
            } else {
                 el.classList.add('bg-blue-100', 'text-blue-700');
            }

            setTimeout(() => {
                el.classList.add('hidden');
            }, 5000);
        };

        const generateId = () => Math.random().toString(36).substring(2, 9);


        // --- Drawing Logic Helpers ---

        const getAvailableParticipants = () => {
            return appState.participants.filter(p => p.available);
        };

        // --- Setup Logic ---

        const parseParticipants = (input) => {
            const lines = input.trim().split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const parts = line.trim().split(/\s+/);
                
                if (parts.length < 2) {
                    const name = parts[0] || '';
                    const id = generateId();
                    return { id, name, available: true };
                }
                
                const id = parts[0];
                const name = parts.slice(1).join(' '); 
                
                return { id, name, available: true };
            });
        };

        const parsePrizes = (input) => {
            const lines = input.trim().split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {

                const parts = line.trim().split(/\s+/);
                
                if (parts.length < 2) {

                    return { id: generateId(), name: parts[0] || 'ç„¡åç¨±çé …', quantity: 1, drawn: 0 };
                }

                // å‡è¨­æ ¼å¼ç‚º: [çé …åç¨±] [æ•¸é‡]
                const quantityStr = parts[parts.length - 1];
                const quantity = parseInt(quantityStr, 10);
                
                const name = parts.slice(0, parts.length - 1).join(' ');
                
                return { id: generateId(), name, quantity: isNaN(quantity) ? 1 : quantity, drawn: 0 };
            });
        };

        const handleSaveSetup = () => {
            const participantInput = document.getElementById('participantInput').value;
            const prizeInput = document.getElementById('prizeInput').value;

            const newParticipants = parseParticipants(participantInput);
            const newPrizes = parsePrizes(prizeInput);

            if (newParticipants.length === 0) {
                showStatusMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒèˆ‡è€…è³‡æ–™ã€‚", 'error');
                return;
            }
            if (newPrizes.length === 0) {
                showStatusMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„çé …è³‡æ–™ã€‚", 'error');
                return;
            }


            appState.participants = newParticipants;
            appState.prizes = newPrizes;
            appState.results = []; // è¼‰å…¥æ–°è³‡æ–™æ™‚æ¸…ç©ºçµæœ

            // è¼‰å…¥æ–°çé …å¾Œï¼Œé é¸ç¬¬ä¸€å€‹å¯æŠ½çš„çé …
            const firstAvailablePrize = newPrizes.find(p => p.drawn < p.quantity);
            appState.selectedPrizeId = firstAvailablePrize ? firstAvailablePrize.id : null;

            saveState();
            showStatusMessage(`å·²è¼‰å…¥ ${newParticipants.length} ä½åƒèˆ‡è€…å’Œ ${newPrizes.length} å€‹çé …ã€‚`, 'success');

            // é‡æ–°æ¸²æŸ“ Draw å’Œ Results é¢æ¿
            renderDrawPanel();
            renderResultsPanel();
        };

        const handleResetApp = () => {
            if (window.confirm("ç¢ºå®šè¦é‡è¨­æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡æ¸…ç©ºåƒèˆ‡è€…ã€çé …å’Œçµæœã€‚")) {
                appState.participants = [];
                appState.prizes = [];
                appState.results = [];
                appState.selectedPrizeId = null; // æ¸…ç©ºé¸å–çš„çé …
                localStorage.removeItem(STORAGE_KEY);
                document.getElementById('participantInput').value = '';
                document.getElementById('prizeInput').value = '';
                showStatusMessage("æ‡‰ç”¨ç¨‹å¼è³‡æ–™å·²å®Œå…¨é‡è¨­ã€‚", 'info');
                renderDrawPanel();
                renderResultsPanel();
                document.getElementById('tabNavigation').querySelector('[data-tab="setup"]').click();
            }
        };


        // --- Drawing Control ---

        /**
         * è™•ç†çé …é¸å–
         * @param {string} prizeId - è¢«é¸å–çš„çé … ID
         */
        const handlePrizeSelect = (prizeId) => {
            const prize = appState.prizes.find(p => p.id === prizeId);
            if (prize && prize.drawn < prize.quantity) {
                appState.selectedPrizeId = prizeId;
                renderDrawPanel(); // é‡æ–°æ¸²æŸ“ Draw Panel ä»¥æ›´æ–°é¡¯ç¤º
                showStatusMessage(`å·²é¸å–çé …ï¼š${prize.name}`, 'info');
            } else {
                showStatusMessage("è©²çé …å·²æŠ½å®Œæˆ–ä¸å­˜åœ¨ï¼Œç„¡æ³•é¸å–ã€‚", 'error');
            }
        };


        const startDraw = () => {
            if (appState.isDrawing) return;

            // ä½¿ç”¨é¸å–çš„çé …
            const prize = appState.prizes.find(p => p.id === appState.selectedPrizeId); 
            const availableParticipants = getAvailableParticipants();

            if (!prize) {
                showStatusMessage("è«‹å…ˆé¸å–ä¸€å€‹æœ‰æ•ˆçš„çé …ï¼", 'error');
                return;
            }
            if (prize.drawn >= prize.quantity) {
                showStatusMessage("è©²çé …å·²æŠ½å®Œï¼è«‹é¸å–å…¶ä»–çé …ã€‚", 'error');
                return;
            }
            if (availableParticipants.length === 0) {
                showStatusMessage("æ²’æœ‰å¯æŠ½çš„åƒèˆ‡è€…äº†ï¼", 'info');
                return;
            }

            appState.isDrawing = true;
            appState.currentWinner = null;
            showStatusMessage(`æ­£åœ¨ç‚ºã€${prize.name}ã€‘é€²è¡ŒæŠ½ç...`, 'info');
            renderDrawPanel(); // ç«‹å³æ›´æ–° UI é¡¯ç¤ºæŠ½çä¸­

            // Animation loop
            const names = availableParticipants.map(p => p.name);
            shuffleInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * names.length);
                appState.shufflingName = names[randomIndex];
                // åªæ›´æ–°å‹•ç•«é¡¯ç¤ºå€
                const animEl = document.getElementById('animationDisplay');
                if (animEl) {
                    animEl.innerHTML = `<p class="text-5xl font-extrabold text-yellow-400 animate-pulse-fast">${appState.shufflingName || '...'}</p>`;
                }
            }, 100);

            // Stop and determine winner after a delay
            setTimeout(() => {
                clearInterval(shuffleInterval);

                const winnerIndex = Math.floor(Math.random() * availableParticipants.length);
                const winner = availableParticipants[winnerIndex];

                if (!winner) {
                    appState.isDrawing = false;
                    appState.shufflingName = '';
                    showStatusMessage("æŠ½çå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚", 'error');
                    renderDrawPanel();
                    return;
                }

                // 1. Update Participants (mark as unavailable)
                appState.participants = appState.participants.map(p =>
                    p.id === winner.id ? { ...p, available: false } : p
                );

                // 2. Update Prizes (increment drawn count)
                appState.prizes = appState.prizes.map(p =>
                    p.id === prize.id ? { ...p, drawn: p.drawn + 1 } : p
                );

                // 3. Update Results (add new result)
                const newResult = {
                    id: generateId(),
                    prizeName: prize.name,
                    winnerName: winner.name,
                    winnerId: winner.id,
                    timestamp: new Date().toISOString(),
                };
                appState.results.unshift(newResult); // æ”¾åˆ°æœ€å‰é¢

                appState.currentWinner = winner;
                appState.shufflingName = winner.name;
                appState.isDrawing = false;

                // æª¢æŸ¥è©²çé …æ˜¯å¦å·²æŠ½å®Œï¼ŒæŠ½å®Œå‰‡å–æ¶ˆé¸å–
                const updatedPrize = appState.prizes.find(p => p.id === prize.id);
                if (updatedPrize && updatedPrize.drawn >= updatedPrize.quantity) {
                    appState.selectedPrizeId = null; 
                }

                saveState(); // Save results
                showStatusMessage(`æ­å–œï¼ã€${prize.name}ã€‘å¾—çè€…æ˜¯ ${winner.name}ï¼`, 'success');
                renderDrawPanel();
                renderResultsPanel(); // Update results list
            }, 3000); // 3 second drawing time
        };


        // --- Export Logic ---

        /**
         * åŒ¯å‡ºæŠ½ççµæœç‚º CSV æª”æ¡ˆ
         */
        const exportResultsToCSV = () => {
            if (appState.results.length === 0) {
                showStatusMessage("æ²’æœ‰æŠ½ççµæœå¯ä¾›åŒ¯å‡ºã€‚", 'info');
                return;
            }

            // 1. å®šç¾© CSV æ¨™é¡Œ
            const headers = ["ç·¨è™Ÿ", "å§“å", "çé …", "æ™‚é–“"];
            let csv = headers.join(',') + '\n';

            // 2. æ ¼å¼åŒ–çµæœæ•¸æ“š
            appState.results.forEach(r => {
                const timestamp = new Date(r.timestamp).toLocaleString('zh-TW');
                
                // å¦‚æœå…§å®¹åŒ…å«é€—è™Ÿæˆ–å¼•è™Ÿï¼Œéœ€è¦ç”¨é›™å¼•è™ŸåŒ…è£¹ä¸¦é€¸å‡ºå…§éƒ¨é›™å¼•è™Ÿ
                const escapeCSV = (data) => `"${data.replace(/"/g, '""')}"`;
                
                const row = [
                    r.winnerId, 
                    escapeCSV(r.winnerName),
                    escapeCSV(r.prizeName),
                    escapeCSV(timestamp)
                ].join(',');
                csv += row + '\n';
            });

            // 3. å‰µå»º Blob å’Œä¸‹è¼‰é€£çµ
            // ä½¿ç”¨ UTF-8 BOM ç¢ºä¿ä¸­æ–‡åœ¨ Excel ä¸­æ­£ç¢ºé¡¯ç¤º
            const bom = '\ufeff'; 
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'å¹¸é‹æŠ½ççµæœ.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatusMessage("æŠ½ççµæœå·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆã€‚", 'success');
        };

        /**
         * åŒ¯å‡ºæœªä¸­çåƒèˆ‡è€…åå–®ç‚º CSV æª”æ¡ˆ (æ–°å¢)
         */
        const exportAvailableParticipantsToCSV = () => {
            const availableParticipants = getAvailableParticipants();

            if (availableParticipants.length === 0) {
                showStatusMessage("æ²’æœ‰æœªä¸­çåƒèˆ‡è€…å¯ä¾›åŒ¯å‡ºã€‚", 'info');
                return;
            }

            // 1. å®šç¾© CSV æ¨™é¡Œ
            const headers = ["ç·¨è™Ÿ", "å§“å"];
            let csv = headers.join(',') + '\n';

            // 2. æ ¼å¼åŒ–çµæœæ•¸æ“š
            availableParticipants.forEach(p => {
                // å¦‚æœå…§å®¹åŒ…å«é€—è™Ÿæˆ–å¼•è™Ÿï¼Œéœ€è¦ç”¨é›™å¼•è™ŸåŒ…è£¹ä¸¦é€¸å‡ºå…§éƒ¨é›™å¼•è™Ÿ
                const escapeCSV = (data) => `"${data.replace(/"/g, '""')}"`;
                
                const row = [
                    p.id, 
                    escapeCSV(p.name)
                ].join(',');
                csv += row + '\n';
            });

            // 3. å‰µå»º Blob å’Œä¸‹è¼‰é€£çµ
            const bom = '\ufeff'; 
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'æœªä¸­çåƒèˆ‡è€….csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatusMessage("æœªä¸­çåƒèˆ‡è€…åå–®å·²åŒ¯å‡ºç‚º CSV æª”æ¡ˆã€‚", 'success');
        };


        // --- Rendering Functions (UI Components) ---

        /**
         * æ¸²æŸ“ Card å®¹å™¨
         */
        const renderCard = (title, contentHTML, icon = 'âœ¨', className = '') => `
            <div class="bg-white shadow-xl rounded-xl p-6 ${className}">
                <h2 class="text-2xl font-bold mb-4 text-indigo-700 flex items-center">
                    <span class="text-3xl mr-2">${icon}</span>
                    ${title}
                </h2>
                ${contentHTML}
            </div>
        `;

        /**
         * æ¸²æŸ“çé …æ¸…å–® (å¯é»æ“Šé¸å–)
         */
        const renderPrizeList = () => {
            if (appState.prizes.length === 0) {
                return '<p class="text-gray-500">è«‹å…ˆåœ¨è¨­å®šé é¢è¼‰å…¥çé …ã€‚</p>';
            }
            return `
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${appState.prizes.map(p => {
                        const isSelected = p.id === appState.selectedPrizeId;
                        const isAvailable = p.drawn < p.quantity;
                        const bgColor = isSelected ? 'bg-indigo-200' : 'bg-indigo-50/50 hover:bg-indigo-100';
                        const cursorStyle = isAvailable ? 'cursor-pointer' : 'cursor-not-allowed opacity-70';
                        const clickHandler = isAvailable ? `onclick="handlePrizeSelect('${p.id}')"` : '';

                        return `
                            <div ${clickHandler} class="flex justify-between items-center p-3 ${bgColor} rounded-lg transition duration-200 ${cursorStyle}">
                                <span class="font-semibold text-gray-700">${p.name} ${isSelected ? '(å·²é¸å–)' : ''}</span>
                                <span class="px-3 py-1 text-sm font-medium rounded-full ${isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    å·²æŠ½/ç¸½æ•¸: ${p.drawn} / ${p.quantity}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        /**
         * æ¸²æŸ“ Draw Panel
         */
        const renderDrawPanel = () => {
            // æ‰¾åˆ°ç•¶å‰é¸å–çš„çé …
            const currentSelectedPrize = appState.prizes.find(p => p.id === appState.selectedPrizeId);

            // åˆ¤æ–·æŠ½çæŒ‰éˆ•æ˜¯å¦æ‡‰ç¦ç”¨
            const isDrawDisabled = appState.isDrawing || 
                                   !currentSelectedPrize || 
                                   currentSelectedPrize.drawn >= currentSelectedPrize.quantity || 
                                   getAvailableParticipants().length === 0;

            const availableParticipantsCount = getAvailableParticipants().length;
            const totalParticipantsCount = appState.participants.length;
            const latestResult = appState.results[0];

            // --- æŠ½çæ§åˆ¶å° (Card 1) ---
            const controlPanelHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex flex-col space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800">ç•¶å‰é¸å–çé …</h3>
                        ${currentSelectedPrize ? `
                            <div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg">
                                <p class="text-lg font-bold text-indigo-700">ã€${currentSelectedPrize.name}ã€‘</p>
                                <p class="text-sm text-gray-600">å‰©é¤˜æ•¸é‡ï¼š${currentSelectedPrize.quantity - currentSelectedPrize.drawn}</p>
                            </div>
                        ` : `
                            <div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                                <p class="text-lg font-bold text-yellow-700">è«‹å…ˆåœ¨å³å´æ¸…å–®é¸å–ä¸€å€‹å¯æŠ½çé …</p>
                            </div>
                        `}
                        <button
                            onclick="startDraw()"
                            ${isDrawDisabled ? 'disabled' : ''}
                            class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            ${appState.isDrawing ? `
                                <svg class="w-5 h-5 mr-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12a7.96 7.96 0 003.58 6.58L4 16v5h5.582M20 20l-3.58-3.58A7.96 7.96 0 0020 12a7.96 7.96 0 00-3.58-6.58L20 8V4h-5.582"></path></svg>
                                æŠ½çä¸­...
                            ` : `
                                ğŸ† é–‹å§‹æŠ½ç
                            `}
                        </button>
                    </div>

                    <div class="flex flex-col space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800">çé …æ¸…å–®</h3>
                        ${renderPrizeList()}
                        <div class="text-sm text-gray-500">
                            ğŸ‘¥ å‰©é¤˜å¯æŠ½äººæ•¸: ${availableParticipantsCount} / ${totalParticipantsCount}
                        </div>
                    </div>
                </div>
            `;

            // --- å‹•ç•«é¡¯ç¤º (Card 2) ---
            let animationContent;
            if (appState.isDrawing) {
                animationContent = `
                    <p class="text-5xl font-extrabold text-yellow-400 animate-pulse-fast">
                        ${appState.shufflingName || '...'}
                    </p>
                `;
            } else if (appState.currentWinner) {
                animationContent = `
                    <div class="space-y-2">
                        <span class="text-6xl mx-auto block">ğŸ‰</span>
                        <p class="text-xl text-green-400 font-semibold">æ­å–œå¾—çï¼</p>
                        <p class="text-6xl font-extrabold text-yellow-300">
                            ${appState.currentWinner.name}
                        </p>
                        <p class="text-2xl font-medium text-indigo-200">ç²å¾—ï¼š${latestResult?.prizeName || 'æœªçŸ¥çé …'}</p>
                    </div>
                `;
            } else {
                animationContent = `
                    <p class="text-2xl font-light text-indigo-300">é»æ“Šã€Œé–‹å§‹æŠ½çã€ä¾†æŠ½å‡ºå¾—çè€…</p>
                `;
            }

            const animationCardHTML = renderCard(
                'æŠ½ççµæœ',
                `<div id="animationDisplay" class="h-48 flex items-center justify-center">${animationContent}</div>`,
                'âœ¨',
                'text-center bg-indigo-800 text-white'
            );


            document.getElementById('draw-panel').innerHTML = `
                <div class="space-y-6">
                    ${renderCard('æŠ½çæ§åˆ¶å°', controlPanelHTML, 'âš™ï¸')}
                    ${animationCardHTML}
                </div>
            `;
        };

        /**
         * æ¸²æŸ“ Setup Panel
         */
        const renderSetupPanel = () => {
            const setupPanelEl = document.getElementById('setup-panel');
            // Helper function to format participant data for textarea display
            const formatParticipantsForDisplay = (participants) => {
                // Ensure the displayed format matches the input format (ID SPACE Name)
                return participants.map(p => `${p.id} ${p.name}`).join('\n');
            };

            // Helper function to format prize data for textarea display
            const formatPrizesForDisplay = (prizes) => {
                // Ensure the displayed format matches the input format (Name SPACE Quantity)
                return prizes.map(p => `${p.name} ${p.quantity}`).join('\n');
            };

            setupPanelEl.innerHTML = `
                <div class="space-y-6">
                    ${renderCard('åƒèˆ‡è€…è³‡æ–™', `
                        <p class="text-sm text-gray-600 mb-3">è«‹è²¼ä¸Šæ‚¨å¾ Google Sheet è¤‡è£½çš„ã€Œç·¨è™Ÿ å§“åã€è³‡æ–™ï¼Œä¸­é–“ä»¥ç©ºæ ¼åˆ†éš”ï¼Œæ¯è¡Œä¸€ç­†ã€‚</p>
                        <textarea
                            id="participantInput"
                            placeholder="ä¾‹å¦‚ï¼š\\n1 å¼µä¸‰\\n2 æå››\\n3 ç‹äº”"
                            rows="6"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono"
                        >${formatParticipantsForDisplay(appState.participants)}</textarea>
                        <p class="mt-2 text-sm text-gray-500">å·²è¼‰å…¥äººæ•¸ï¼š${appState.participants.length} äºº</p>
                    `, 'ğŸ‘¤')}

                    ${renderCard('çé …èˆ‡æ•¸é‡', `
        
                        <p class="text-sm text-gray-600 mb-3">è«‹è²¼ä¸Šæ‚¨å¾ Google Sheet è¤‡è£½çš„ã€Œçé …åç¨± æ•¸é‡ã€è³‡æ–™ï¼Œæ¯è¡Œä¸€ç­†ã€‚</p>
                        <textarea
                            id="prizeInput"
                            placeholder="ä¾‹å¦‚ï¼š\\nä¸€ç­‰ç 1\\näºŒç­‰ç 5\\nä¸‰ç­‰ç 10"
                            rows="4"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono"
                        >${formatPrizesForDisplay(appState.prizes)}</textarea>
                        <p class="mt-2 text-sm text-gray-500">å·²è¨­å®šçé …æ•¸ï¼š${appState.prizes.length} å€‹</p>
                    `, 'ğŸ')}

                    <div class="grid grid-cols-2 gap-4">
                        <button
                            onclick="handleSaveSetup()"
                            class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center"
                        >
                            ğŸ’¾ å„²å­˜ä¸¦è¼‰å…¥è³‡æ–™
                        </button>
                        <button
                            onclick="handleResetApp()"
                            class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex items-center justify-center"
                        >
                            âŒ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                        </button>
                    </div>
                </div>
            `;
        };

        /**
         * æ¸²æŸ“ Results Panel
         */
        const renderResultsPanel = () => {
            const availableParticipants = getAvailableParticipants();

            // æŠ½ççµæœç´€éŒ„
            const resultsListHTML = appState.results.length === 0
                ? '<p class="text-gray-500">å°šæœªæœ‰æŠ½ççµæœã€‚</p>'
                : `
                    <div class="max-h-[500px] overflow-y-auto space-y-2">
                        ${appState.results.map((r, index) => `
                            <div class="p-4 rounded-lg shadow-sm flex justify-between items-center ${index === 0 ? 'bg-yellow-50 border-2 border-yellow-500' : 'bg-gray-50'}" style="white-space: nowrap;">
                                <div class="flex-1 min-w-0 pr-2">
                                    <p class="font-semibold text-gray-800 truncate">${r.winnerName}</p>
                                    <p class="text-sm text-gray-500 truncate">ç·¨è™Ÿ: ${r.winnerId}</p>
                                </div>
                                <div class="ml-4 text-right">
                                    <p class="text-base font-bold text-indigo-600">${r.prizeName}</p>
                                    <p class="text-xs text-gray-400">${new Date(r.timestamp).toLocaleString('zh-TW')}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

            // æœªä¸­çåƒèˆ‡è€…
            const availableListHTML = availableParticipants.length === 0
                ? '<p class="text-gray-500">æ‰€æœ‰äººéƒ½å·²ä¸­çæˆ–è¢«æŠ½å…‰ï¼</p>'
                : `
                    <div class="flex flex-wrap gap-2">
                        ${availableParticipants.map(p => `
                            <span class="text-sm px-3 py-1 bg-blue-100 text-blue-800 rounded-full">
                                ${p.name} (${p.id})
                            </span>
                        `).join('')}
                    </div>
                `;

            const resultsPanelEl = document.getElementById('results-panel');
            resultsPanelEl.innerHTML = `
                <div class="space-y-6">
                    ${renderCard('æŠ½ççµæœç´€éŒ„', `
                        <button 
                            onclick="exportResultsToCSV()"
                            class="w-full mb-4 py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center disabled:opacity-50"
                        >
                            ğŸ“¥ åŒ¯å‡ºä¸­çåå–® CSV æª”æ¡ˆ
                        </button>
                        ${resultsListHTML}
                    `, 'ğŸ“œ')}
                    ${renderCard('æœªä¸­çåƒèˆ‡è€…', `
                        <button 
                            onclick="exportAvailableParticipantsToCSV()"
                            class="w-full mb-4 py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center disabled:opacity-50"
                        >
                            ğŸ“¥ åŒ¯å‡ºæœªä¸­çåå–® CSV æª”æ¡ˆ
                        </button>
                        ${availableListHTML}
                    `, 'ğŸ‘¥')}
                </div>
            `;
        };


        // --- Tab Control Logic ---
        const setupTabControl = () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // åˆå§‹åŒ–æ¨£å¼
            tabButtons.forEach(button => {
                button.classList.add('flex', 'items-center', 'px-4', 'py-2', 'text-sm', 'font-medium', 'rounded-t-lg', 'transition-all', 'duration-200', 'bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
            });
            const activeTabButton = document.querySelector('.tab-button.active-tab');
            if(activeTabButton) {
                activeTabButton.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                activeTabButton.classList.add('bg-white', 'text-indigo-700', 'border-b-4', 'border-indigo-500');
            }


            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;

                    // éš±è—æ‰€æœ‰å…§å®¹ï¼Œé‡è¨­æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
                    tabContents.forEach(content => content.classList.add('hidden'));
                    tabButtons.forEach(btn => {
                        btn.classList.remove('bg-white', 'text-indigo-700', 'border-b-4', 'border-indigo-500', 'active-tab');
                        btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                    });

                    // é¡¯ç¤ºç›®æ¨™å…§å®¹ï¼Œè¨­å®šç›®æ¨™æŒ‰éˆ•æ¨£å¼
                    document.getElementById(`${targetTab}-panel`).classList.remove('hidden');
                    button.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                    button.classList.add('bg-white', 'text-indigo-700', 'border-b-4', 'border-indigo-500', 'active-tab');
                });
            });
        };

        // --- Application Initialization ---
        const initializeApp = () => {
            loadState();
            renderDrawPanel();
            renderSetupPanel();
            renderResultsPanel();
            setupTabControl();
        };

        window.onload = initializeApp;

        // æš´éœ²çµ¦å…¨å±€ï¼Œè®“ HTML ä¸­çš„ onclick å¯ä»¥å‘¼å«
        window.handleSaveSetup = handleSaveSetup;
        window.handleResetApp = handleResetApp;
        window.startDraw = startDraw;
        window.handlePrizeSelect = handlePrizeSelect; // æš´éœ²æ–°çš„é¸å–å‡½å¼
        window.exportResultsToCSV = exportResultsToCSV; // æš´éœ² CSV åŒ¯å‡ºå‡½å¼
        window.exportAvailableParticipantsToCSV = exportAvailableParticipantsToCSV; // æš´éœ²æ–°çš„ CSV åŒ¯å‡ºå‡½å¼

    </script>
</body>
</html>
